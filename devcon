#!/bin/bash

# DevCon - Development Container Manager for QuranRef
# A comprehensive script for managing container development environment
# Supports both Podman (preferred) and Docker

set -e

# Configuration
COMPOSE_FILE="docker-compose.dev.yml"
PROJECT_NAME="quranref"

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Function to print colored output
print_info() { printf "${CYAN}ℹ ${NC}%s\n" "$1"; }
print_success() { printf "${GREEN}✓${NC} %s\n" "$1"; }
print_warning() { printf "${YELLOW}⚠${NC} %s\n" "$1"; }
print_error() { printf "${RED}✗${NC} %s\n" "$1"; }
print_header() { printf "\n${BLUE}=== %s ===${NC}\n" "$1"; }

# Detect container runtime (prefer Podman over Docker)
CONTAINER_RUNTIME=""
COMPOSE_CMD=""

detect_runtime() {
    # Check for Podman first (preferred)
    if command -v podman &>/dev/null && podman info &>/dev/null 2>&1; then
        CONTAINER_RUNTIME="podman"
        # Check for podman-compose or podman compose
        if command -v podman-compose &>/dev/null; then
            COMPOSE_CMD="podman-compose"
        elif podman compose version &>/dev/null 2>&1; then
            COMPOSE_CMD="podman compose"
        else
            print_error "Podman found but no compose support. Install podman-compose: pip install podman-compose"
            exit 1
        fi
    # Fall back to Docker
    elif command -v docker &>/dev/null && docker info &>/dev/null 2>&1; then
        CONTAINER_RUNTIME="docker"
        COMPOSE_CMD="docker compose"
    else
        print_error "No container runtime found. Please install Podman or Docker."
        exit 1
    fi
}

# Check container runtime is available
check_runtime() {
    detect_runtime
    print_info "Using $CONTAINER_RUNTIME with $COMPOSE_CMD"
}

# Main function to display help
show_help() {
    printf "${GREEN}DevCon - Development Container Manager${NC}\n"
    printf "Supports both Podman (preferred) and Docker\n"
    printf "\n"
    printf "${YELLOW}Usage:${NC}\n"
    printf "  ./devcon [command] [options]\n"
    printf "\n"
    printf "${YELLOW}Core Commands:${NC}\n"
    printf "  up              Start with hot-reload + watch mode (Ctrl+C to stop)\n"
    printf "  up -d           Start in background (detached, no watch)\n"
    printf "  down            Stop all services\n"
    printf "  restart         Restart all services\n"
    printf "  status          Show status of all services\n"
    printf "  clean           Stop services and remove volumes (WARNING: deletes data!)\n"
    printf "\n"
    printf "${YELLOW}Service Commands:${NC}\n"
    printf "  logs [service]  Show logs (all services or specific: backend/frontend/db)\n"
    printf "  shell [service] Open shell in service (default: backend)\n"
    printf "  exec <service> <cmd>  Execute command in service\n"
    printf "\n"
    printf "${YELLOW}Development Commands:${NC}\n"
    printf "  build [service] Rebuild images (all or specific service)\n"
    printf "  sync            Install/update dependencies in containers\n"
    printf "  test            Run backend tests\n"
    printf "  lint            Run linting (ruff) on backend code\n"
    printf "  format          Format backend code with ruff\n"
    printf "\n"
    printf "${YELLOW}Database Commands:${NC}\n"
    printf "  db-init         Initialize database structure and populate with Quran data\n"
    printf "  db-populate     Populate database with Quran data (without init)\n"
    printf "  db-reset        Reset database (drop and recreate)\n"
    printf "  db-backup       Backup database to ./backups/\n"
    printf "  db-restore <file> Restore database from backup\n"
    printf "\n"
    printf "${YELLOW}Quick Access:${NC}\n"
    printf "  urls            Show all service URLs\n"
    printf "  ps              Show running containers (detailed)\n"
    printf "  runtime         Show detected container runtime\n"
    printf "\n"
    printf "${YELLOW}Examples:${NC}\n"
    printf "  ./devcon up           # Start development environment\n"
    printf "  ./devcon logs backend # View backend logs\n"
    printf "  ./devcon shell        # Open backend shell\n"
    printf "  ./devcon shell frontend # Open frontend shell\n"
    printf "  ./devcon test         # Run backend tests\n"
    printf "  ./devcon db-init      # Initialize database\n"
    printf "\n"
    printf "${YELLOW}Service URLs:${NC}\n"
    printf "  Frontend:    http://localhost:41149\n"
    printf "  Backend:     http://localhost:41148\n"
    printf "  PostgreSQL:  localhost:15432\n"
}

# Start all services
cmd_up() {
    local detached=false

    # Check for -d flag
    if [ "$1" = "-d" ]; then
        detached=true
    fi

    if [ "$detached" = true ]; then
        print_header "Starting Development Environment (Detached)"
        print_info "Starting containers in background..."
        $COMPOSE_CMD -f $COMPOSE_FILE up -d

        print_info "Waiting for services to be ready..."
        sleep 3

        if $COMPOSE_CMD -f $COMPOSE_FILE ps | grep -qiE "running|up"; then
            print_success "All services started successfully!"
            cmd_urls
            print_info "Run './devcon logs' to view logs"
            print_info "Run './devcon down' to stop services"
        else
            print_error "Some services failed to start. Check logs with './devcon logs'"
            $COMPOSE_CMD -f $COMPOSE_FILE ps
        fi
    else
        print_header "Starting Development Environment"
        print_info "Hot-reload enabled via volume mounts"
        print_info "Watch mode: auto-rebuilds on Dockerfile/dependency changes"
        print_info "Press Ctrl+C to stop all services"
        echo ""
        cmd_urls
        echo ""
        $COMPOSE_CMD -f $COMPOSE_FILE up --watch
    fi
}

# Stop all services
cmd_down() {
    print_header "Stopping Development Environment"
    $COMPOSE_CMD -f $COMPOSE_FILE down
    print_success "All services stopped"
}

# Restart services
cmd_restart() {
    print_header "Restarting Development Environment"
    cmd_down
    cmd_up
}

# Show service status
cmd_status() {
    print_header "Service Status"
    $COMPOSE_CMD -f $COMPOSE_FILE ps
}

# Show service URLs
cmd_urls() {
    print_header "Service URLs"
    printf "${GREEN}Frontend:${NC}    http://localhost:41149 (Vue.js with hot-reload)\n"
    printf "${GREEN}Backend:${NC}     http://localhost:41148 (FastAPI with auto-reload)\n"
    printf "${GREEN}API Docs:${NC}    http://localhost:41148/docs (Swagger UI)\n"
    printf "${GREEN}PostgreSQL:${NC}  localhost:15432 (Database)\n"
}

# Show logs
cmd_logs() {
    local service=$1

    if [ -z "$service" ]; then
        print_header "Showing logs for all services"
        $COMPOSE_CMD -f $COMPOSE_FILE logs -f --tail=50
    else
        case $service in
            backend|back|api)
                print_header "Backend Logs"
                $COMPOSE_CMD -f $COMPOSE_FILE logs -f --tail=50 backend
                ;;
            frontend|front|vue)
                print_header "Frontend Logs"
                $COMPOSE_CMD -f $COMPOSE_FILE logs -f --tail=50 frontend
                ;;
            db|database|postgres|pg)
                print_header "Database Logs"
                $COMPOSE_CMD -f $COMPOSE_FILE logs -f --tail=50 postgres
                ;;
            *)
                print_error "Unknown service: $service"
                print_info "Available: backend, frontend, db"
                exit 1
                ;;
        esac
    fi
}

# Open shell in container
cmd_shell() {
    local service=${1:-backend}

    case $service in
        backend|back|api)
            print_header "Opening Backend Shell"
            print_info "Python environment with uv ready. Try: uv run quranref-cli --help"
            $COMPOSE_CMD -f $COMPOSE_FILE exec backend bash
            ;;
        frontend|front|vue)
            print_header "Opening Frontend Shell"
            print_info "Bun environment ready. Try: bun run build"
            $COMPOSE_CMD -f $COMPOSE_FILE exec frontend sh
            ;;
        db|database|postgres|pg)
            print_header "Connecting to PostgreSQL"
            $COMPOSE_CMD -f $COMPOSE_FILE exec postgres psql \
                -U "${DB_USERNAME:-quranref}" \
                -d "${DB_NAME:-quranref}"
            ;;
        *)
            print_error "Unknown service: $service"
            print_info "Available: backend, frontend, db"
            exit 1
            ;;
    esac
}

# Execute command in service
cmd_exec() {
    local service=$1
    shift
    local cmd="$@"

    if [ -z "$service" ] || [ -z "$cmd" ]; then
        print_error "Usage: ./devcon exec <service> <command>"
        exit 1
    fi

    print_info "Executing in $service: $cmd"
    $COMPOSE_CMD -f $COMPOSE_FILE exec $service $cmd
}

# Build/rebuild images
cmd_build() {
    local service=$1

    if [ -z "$service" ]; then
        print_header "Rebuilding All Images"
        $COMPOSE_CMD -f $COMPOSE_FILE build
    else
        print_header "Rebuilding $service"
        $COMPOSE_CMD -f $COMPOSE_FILE build $service
    fi
    print_success "Build complete"
}

# Sync dependencies
cmd_sync() {
    print_header "Syncing Dependencies"

    print_info "Backend: Installing Python dependencies..."
    $COMPOSE_CMD -f $COMPOSE_FILE exec backend uv sync

    print_info "Backend: Installing age-orm from source..."
    $COMPOSE_CMD -f $COMPOSE_FILE exec backend pip install -e /age-orm

    print_info "Frontend: Installing JavaScript dependencies..."
    $COMPOSE_CMD -f $COMPOSE_FILE exec frontend bun install

    print_success "Dependencies synced"
}

# Run tests
cmd_test() {
    print_header "Running Backend Tests"
    $COMPOSE_CMD -f $COMPOSE_FILE exec backend pytest -v
}

# Run linting
cmd_lint() {
    print_header "Running Linting"
    $COMPOSE_CMD -f $COMPOSE_FILE exec backend ruff check quranref
}

# Format code
cmd_format() {
    print_header "Formatting Code"
    $COMPOSE_CMD -f $COMPOSE_FILE exec backend ruff format quranref
    print_success "Code formatted"
}

# Database initialization
cmd_db_init() {
    print_header "Initializing Database"

    print_info "Creating database structure..."
    $COMPOSE_CMD -f $COMPOSE_FILE exec backend quranref-cli db init

    print_info "Populating Surah data..."
    $COMPOSE_CMD -f $COMPOSE_FILE exec backend quranref-cli db populate-surahs

    print_success "Database initialized successfully!"
}

# Database populate (without init)
cmd_db_populate() {
    print_header "Populating Database"

    $COMPOSE_CMD -f $COMPOSE_FILE exec backend bash -c "
        quranref-cli db populate-surahs
    "

    print_success "Database populated!"
}

# Database reset
cmd_db_reset() {
    print_warning "This will DELETE all data in the database!"
    read -p "Are you sure? (y/N): " confirm

    if [ "$confirm" = "y" ] || [ "$confirm" = "Y" ]; then
        print_header "Resetting Database"

        print_info "Dropping database and recreating..."
        $COMPOSE_CMD -f $COMPOSE_FILE exec postgres psql \
            -U "${DB_USERNAME:-quranref}" \
            -d "${DB_NAME:-quranref}" \
            -c "DROP SCHEMA IF EXISTS public CASCADE; CREATE SCHEMA public; CREATE EXTENSION IF NOT EXISTS age; SET search_path = ag_catalog, public;"

        cmd_db_init
    else
        print_info "Database reset cancelled"
    fi
}

# Database backup
cmd_db_backup() {
    print_header "Backing Up Database"

    # Create backup directory
    mkdir -p ./backups

    # Generate timestamp
    TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
    BACKUP_FILE="./backups/quranref_${TIMESTAMP}.sql.gz"

    print_info "Creating backup: $BACKUP_FILE"

    $COMPOSE_CMD -f $COMPOSE_FILE exec -T postgres pg_dump \
        -U "${DB_USERNAME:-quranref}" \
        -d "${DB_NAME:-quranref}" \
        --no-owner --no-privileges \
        | gzip > "$BACKUP_FILE"

    print_success "Backup created: $BACKUP_FILE"
}

# Database restore
cmd_db_restore() {
    local backup_file=$1

    if [ -z "$backup_file" ]; then
        print_error "Usage: ./devcon db-restore <backup-file>"
        print_info "Available backups:"
        ls -la ./backups/*.sql.gz 2>/dev/null || print_warning "No backups found"
        exit 1
    fi

    if [ ! -f "$backup_file" ]; then
        print_error "Backup file not found: $backup_file"
        exit 1
    fi

    print_warning "This will REPLACE the current database!"
    read -p "Are you sure? (y/N): " confirm

    if [ "$confirm" = "y" ] || [ "$confirm" = "Y" ]; then
        print_header "Restoring Database"

        gunzip -c "$backup_file" | $COMPOSE_CMD -f $COMPOSE_FILE exec -T postgres psql \
            -U "${DB_USERNAME:-quranref}" \
            -d "${DB_NAME:-quranref}"

        print_success "Database restored from $backup_file"
    else
        print_info "Restore cancelled"
    fi
}

# Clean everything
cmd_clean() {
    print_warning "This will stop all services and DELETE all data!"
    read -p "Are you sure? (y/N): " confirm

    if [ "$confirm" = "y" ] || [ "$confirm" = "Y" ]; then
        print_header "Cleaning Development Environment"
        $COMPOSE_CMD -f $COMPOSE_FILE down -v
        print_success "All services stopped and volumes removed"
    else
        print_info "Clean cancelled"
    fi
}

# Show detailed process list
cmd_ps() {
    print_header "Running Containers"
    # podman-compose doesn't support --format, so use plain ps
    $COMPOSE_CMD -f $COMPOSE_FILE ps
}

# Main script logic
check_runtime

case "${1:-help}" in
    up)
        cmd_up $2
        ;;
    down)
        cmd_down
        ;;
    restart)
        cmd_restart
        ;;
    status)
        cmd_status
        ;;
    logs)
        cmd_logs $2
        ;;
    shell|sh)
        cmd_shell $2
        ;;
    exec)
        shift
        cmd_exec $@
        ;;
    build)
        cmd_build $2
        ;;
    sync)
        cmd_sync
        ;;
    test)
        cmd_test
        ;;
    lint)
        cmd_lint
        ;;
    format|fmt)
        cmd_format
        ;;
    db-init)
        cmd_db_init
        ;;
    db-populate)
        cmd_db_populate
        ;;
    db-reset)
        cmd_db_reset
        ;;
    db-backup)
        cmd_db_backup
        ;;
    db-restore)
        cmd_db_restore $2
        ;;
    urls|url)
        cmd_urls
        ;;
    ps)
        cmd_ps
        ;;
    runtime)
        print_header "Container Runtime"
        printf "Runtime: ${GREEN}$CONTAINER_RUNTIME${NC}\n"
        printf "Compose: ${GREEN}$COMPOSE_CMD${NC}\n"
        ;;
    clean)
        cmd_clean
        ;;
    help|--help|-h|"")
        show_help
        ;;
    *)
        print_error "Unknown command: $1"
        echo ""
        show_help
        exit 1
        ;;
esac
